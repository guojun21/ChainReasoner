# 对话总结：ChainReasoner Q99 痛点优化 — Hop 回溯与 Agent 增强

## 一、主要主题和目标

**Hop 链死循环修复**：Hop2 发现候选人不符约束时回溯 Hop1 重搜；evaluation `valid=False` 且 `confidence<=0.3` 时触发。  
**Agent 主动搜索**：检测「候选全否」模式，强制提示 `web_search` 找替代候选人。  
**knowledge 超时容错**：三层降级（原 API → 短 prompt → 规则伪知识）。  
**后续**：Q0/Q99 回归、80 题批量、痛点分类、蓝图更新。

---

## 二、关键决策和原因

| 决策 | 原因 |
|------|------|
| 回溯每问题限 1 次 | 避免无限回溯耗时长、成本高 |
| 排除词 (-Ndlovu -Fortune) | 参考 Research_Agent，显式排除已知错误候选 |
| LLM 失败时规则 fallback | 保证 LLM 不可用时仍可回溯 |
| 三层 knowledge 降级 | Q99 超时为根因，需逐级降级 |
| 检测最近 3 轮全本地 | Q99 中 4 次 grep 后放弃，3 轮合理 |

---

## 三、修改/创建的文件列表

**constrained_multi_hop_search_agent.py**：回溯方法+hop集成(限1次)；knowledge三层降级；伪知识规则提取。**prompt_builder.py**（原 agentic_system_prompt_builder.py）：Phase2/3 候选人否定与恢复指令。**mini_agent_loop.py**（原 agentic_evidence_review_loop.py）：候选全否检测+countdown强制web_search。

---

## 四、核心代码片段

**Hop 回溯**(~264行)：排除词构造 backtrack_queries，LLM/规则 fallback，重搜 Hop1。**伪知识**(~1358行)：正则提取引号、专名、中文书名。**候选全否**(~103,164行)：最近3轮全本地且未用 web_search → countdown 强制「MUST use web_search」。

---

## 五、解决的问题

**Hop死循环**：Hop2不符无法回溯→回溯重搜。**Agent只看不搜**：4次grep后放弃→检测+countdown强制web_search。**knowledge超时**：LLM三次60s超时→三层降级+伪知识。均待Q99验证。

---

## 六、未解决的待办

1. 目录清理（shim 标注）2. Lint 检查 3. Q0 mini-test 4. Q99 验证 5. 80 题批量与痛点分类 6. 更新蓝图 7. 确认 iCloud 占位文件

---

## 七、技术细节

- 单题：`scripts/run_single_question_log_verification_test.py`，`QUESTION_INDEX=0|99`，日志 `logs/run_YYYYMMDD_HHMMSS/`
- 回溯：`hop_idx>=1` 且 `valid=False`、`confidence<=0.3`，每问题 1 次
- 参考：Research_Agent correct_hop_result、Weaver knowledge gap

---

## 八、达成的共识

1. 候选被硬性否定时优先回溯 Hop1 2. 候选人全否时强制 web_search 3. knowledge 三层 fallback 4. 80 题批量驱动痛点分类

---

## 九、文件清单

**修改（3）**：`constrained_multi_hop_search_agent.py`、`prompt_builder.py`（原 agentic_system_prompt_builder.py）、`mini_agent_loop.py`（原 agentic_evidence_review_loop.py）。**新建（0）**。**总计 3 个**。

---

## 十、当前状态

**已完成**：回溯实现与集成；候选全否检测 + countdown；knowledge 三层降级 + 伪知识；Prompt Phase 2/3 指令。**运行**：代码已落地，未跑回归。**下一步**：shim 与 lint → Q0/Q99 回归 → 80 题批量 → 蓝图更新。

---
**文档创建时间**：2026-02-16 19:01
