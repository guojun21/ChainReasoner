# 代码命名与重构规范

> AI Agent 写代码不需要省字符——命名越详尽越好，让任何读者一眼就知道这个东西是什么、干什么。

---

## 一、文件名

用小写蛇形，完整描述模块职责，不用缩写。

| 反例 | 正例 | 原因 |
|---|---|---|
| `base.py` | `abstract_search_client_interface.py` | "base" 不说明是什么的基类 |
| `client.py` | `language_aware_hybrid_search_dispatcher.py` | 说明核心职责：按语言分发搜索 |
| `mcp_clients.py` | `model_context_protocol_transport_clients.py` | 展开缩写，明确传输层 |
| `eval_baseline.py` | `evaluation_baseline_loader_and_regression_checker.py` | 说明做两件事：加载基线 + 检测回归 |

---

## 二、类名

大驼峰，包含完整语义链：**主体 + 限定 + 角色**。

```python
# 反例
class SearchClient: ...
class MCPHttpClient: ...
class TeeWriter: ...

# 正例
class AbstractSearchClientInterface: ...
class ModelContextProtocolHttpTransportClient: ...
class DualOutputStreamWriter: ...
```

---

## 三、函数 / 方法名

蛇形，用 **动词 + 宾语 + 修饰** 结构，让调用点自文档化。

```python
# 反例
def score_result(query, result): ...
def clean_llm_answer(answer): ...
def _deduplicate(queries): ...
def check_regression(results, ...): ...

# 正例
def calculate_single_search_result_relevance_score(query, result): ...
def strip_llm_preambles_and_extract_core_answer(answer): ...
def _remove_duplicate_queries_preserving_order(queries): ...
def detect_answer_regressions_against_baseline(results, ...): ...
```

私有方法同样详尽，前缀 `_` 仅表示可见性：

```python
# 反例
def _cached_search(self, query): ...
def _phase_hop2(self, question, ...): ...

# 正例
def _perform_search_with_result_caching(self, query): ...
def _run_second_hop_deep_search_phase(self, question, ...): ...
```

---

## 四、常量名

全大写蛇形，说明 **内容 + 用途**。

```python
# 反例
CN_STOPWORDS = {...}
REFUSAL_PHRASES = (...)

# 正例
CHINESE_QUESTION_NOISE_STOPWORDS = {...}
LLM_REFUSAL_AND_INSUFFICIENT_EVIDENCE_PHRASES = (...)
```

---

## 五、Docstring

一句话说 **why**，不重复函数名已经说清楚的 what。

```python
def calculate_single_search_result_relevance_score(query, result):
    """Title matches weighted 2x; Wikipedia/Britannica get authority boosts."""
    ...
```

复杂逻辑加 `Why:` 段落：

```python
def check_if_answer_is_refusal_or_unknown_placeholder(text):
    """True if the text is a refusal, unknown marker, or generic role word.

    Why: The competition requires specific factual answers; generic
    responses like "Unknown" or "The author" score zero.
    """
```

---

## 六、重命名时的向后兼容

旧文件变为 shim，通过 `as` 别名保持旧接口不断：

```python
# src/agents/search_constants.py（shim）
"""Backward-compatibility shim — moved to search_agent_shared_constants_and_stopwords.py."""
from src.agents.search_agent_shared_constants_and_stopwords import (
    CHINESE_QUESTION_NOISE_STOPWORDS as CN_STOPWORDS,
    GENERIC_ENTITY_ROLE_WORDS_TO_REJECT as ENTITY_ROLE_STOPWORDS,
)
```

`__init__.py` 同时导出新名和旧别名：

```python
from src.search.abstract_search_client_interface import AbstractSearchClientInterface

# 旧别名
SearchClient = AbstractSearchClientInterface

__all__ = ["AbstractSearchClientInterface", "SearchClient"]
```

---

## 七、重构执行顺序

按依赖方向，底层先改，上层后改：

1. **常量** → 2. **搜索层** → 3. **Agent 层** → 4. **Pipeline 层** → 5. **API 层** → 6. **界面层** → 7. **脚本层** → 8. **验证**

每一步包含：
- 创建新命名文件（含完整代码）
- 将旧文件改为 shim（仅 import + alias）
- 更新所有引用该模块的 import

最后一步执行 `py_compile` + 全量 `import` 测试。

---

## 八、注释

- **删掉** 描述 what 的注释（代码本身已说明）
- **保留/添加** 解释 why 的注释

```python
# 反例（描述 what）
# Split query into terms
terms = query.split()

# 正例（解释 why）
# Enrich top results with scraped full-page content for better evidence
if self.readpage_client and results:
    ...
```
